# Azure Pipelines equivalent of .github/workflows/run_fetch_script.yml
# Documentation: https://learn.microsoft.com/en-us/azure/devops/pipelines/

trigger: none  # Pas de trigger sur push/PR â€” uniquement scheduled ou manuel

schedules:
  - cron: "0 12 * * *"  # Tous les jours a 12h UTC
    displayName: "Daily fetch at noon UTC"
    branches:
      include:
        - main
    always: true  # Executer meme sans nouveaux commits

pool:
  vmImage: "ubuntu-latest"

variables:
  pythonVersion: "3.11"

steps:
  - checkout: self
    displayName: "Checkout code"

  - task: UsePythonVersion@0
    displayName: "Set up Python $(pythonVersion)"
    inputs:
      versionSpec: "$(pythonVersion)"
      addToPath: true

  - script: |
      curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
      curl https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
      sudo apt-get update
      sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18
      sudo apt-get install -y unixodbc-dev
    displayName: "Install ODBC Driver for SQL Server"

  - script: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
    displayName: "Install Python dependencies"

  - script: python fetch_and_save.py
    displayName: "Run fetch and save script"
    env:
      AZURE_SQL_SERVER: $(AZURE_SQL_SERVER)
      AZURE_SQL_DATABASE: $(AZURE_SQL_DATABASE)
      AZURE_SQL_USERNAME: $(AZURE_SQL_USERNAME)
      AZURE_SQL_PASSWORD: $(AZURE_SQL_PASSWORD)
